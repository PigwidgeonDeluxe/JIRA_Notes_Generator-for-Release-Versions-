<html>

<head>
    <script src="jquery.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="ejs.js"></script>
    <link rel="stylesheet" href="jquery-ui.min.css">
    <script src="jquery.js"></script>
    <script src="jquery-ui.min.js"></script>
    <link href="tabulator.css" rel="stylesheet">
    <script type="text/javascript" src="tabulator.js"></script>
    <link rel="stylesheet" type="text/css" href="globalstyle.css">
</head>


<!--Tabulator tables-->
<div id="main-table-div"></div> 


<script type="text/javascript">
    //run script once the document is fully loaded
    $(document).ready(function() {
        var table_columns = { //define Tabulator
            fitColumns:false,
            colMinWidth:80,
            columns: [ //Define Table Columns //Define columns as percentages to allow for dynamic resizing based on window size 
                {
                    title: "ID",
                    field: "ch_id",
                    sorter: "string",
                    align: "center",
                    formatter: "textarea",
                    width: "10%"
                }, {
                    title: "RFC Name",
                    field: "rfc_name",
                    sorter: "string",
                    align: "center",
                    formatter: "textarea",
                    width: "14%"
                }, {
                    title: "Request Description",
                    field: "description",
                    sorter: "string",
                    sortable: false,
                    formatter: "textarea",
                    width: "41%"
                }, {
                    title: "State",
                    field: "state",
                    sorter: "string",
                    align: "center",
                    formatter: "textarea",
                    width: "7%"
                }, {
                    title: "Priority",
                    field: "priority",
                    sorter: "string",
                    align: "center",
                    formatter: "textarea",
                    width: "7%"
                }, {
                    title: "ImpDate",
                    field: "impdate",
                    sorter: "string",
                    align: "center",
                    formatter: "textarea",
                    width: "7%"
                }, {
                    title: "Effort",
                    field: "effort",
                    sorter: "string",
                    align: "center",
                    formatter: "textarea",
                    width: "6%"

                }, {
                    title: "Assignee",
                    field: "assignee",
                    sorter: "string",
                    align: "center",
                    formatter: "textarea",
                    width: "8%"
                },
            ],
            rowClick: function(e, id, data, row) { //open the issue for the row when the row is clicked
                window.open("https://ondhdp.atlassian.net/projects/" + ((table_data[id]["ch_id"]).split("-"))[0] + "/issues/" + table_data[id]["ch_id"]);
            },
        };
        //create the html tables (divs)
        //define some data from sent json data from nodejs server
        var table_data = <%- JSON.stringify(release_data) %>
        var release_versions = <%- JSON.stringify(releases) %>
        var releaseamount = release_versions.length;
        var formatted_release_versions = [];
        var content = "<table>";
        console.log(table_data, release_versions)

        //remove spaces and periods
        for (i = 0; i < releaseamount; i++){
            formatted_release_versions.push(release_versions[i].replace(/[ .]/g, "-" ));
        }

        //populate and create the column cells/data
        for (j = 0; j < releaseamount; j++) { //loop by row
            content += "<h1 id='table_header'>" + release_versions[j] + "</h1>"
            content += "<div id='main-table-" + formatted_release_versions[j] + "'" + ">" + "</div>";
            
        }
        content += "</table>"

        console.log(content)
        //add the table to the divs created before
        $('#main-table-div').append(content)
        //console.log("RV" + release_versions.length)
        for (k = 0; k < releaseamount; k++){
            //initialize the table
            $("#main-table-" + formatted_release_versions[k]).tabulator(table_columns);
            //load data into the table for current div 
            $("#main-table-" + formatted_release_versions[k]).tabulator("setData", table_data[release_versions[k]]);

            //console.log("#main-table-" + formatted_release_versions[k] + table_data[release_versions[k]])
        }

        
    });
</script>

</html>